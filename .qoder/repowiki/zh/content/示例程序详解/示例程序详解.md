# 示例程序详解

<cite>
**本文档中引用的文件**  
- [advanced_analyzer.cpp](file://examples/advanced_analyzer.cpp)
- [live_capture.cpp](file://examples/live_capture.cpp)
- [performance_benchmark.cpp](file://examples/performance_benchmark.cpp)
- [CMakeLists.txt](file://examples/CMakeLists.txt)
- [protocol_detection.hpp](file://include/detection/protocol_detection.hpp)
- [base_parser.hpp](file://include/parsers/base_parser.hpp)
- [traffic_statistics.hpp](file://include/statistics/traffic_statistics.hpp)
- [network_utils.hpp](file://include/utils/network_utils.hpp)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考量](#性能考量)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本文档旨在全面解析 `examples` 目录下的三个核心示例程序：`advanced_analyzer.cpp`（高级流量分析）、`live_capture.cpp`（实时数据包捕获）和 `performance_benchmark.cpp`（性能基准测试）。通过逐个讲解其设计逻辑、构建方式、运行参数与预期输出，揭示如何在实际项目中集成 `protocol_praser` 库，展示从 Npcap 捕获数据包到协议解析再到结果输出的完整工作流。

## 项目结构
`examples` 目录包含三个主要示例程序，分别用于演示不同场景下的协议解析能力。这些程序依赖于 `include` 和 `src` 目录中的核心库模块，并通过 CMake 构建系统进行编译。示例程序展示了库的典型使用模式，包括实时捕获、深度协议分析和性能评估。

```mermaid
graph TB
subgraph "示例程序"
A[advanced_analyzer.cpp]
B[live_capture.cpp]
C[performance_benchmark.cpp]
end
subgraph "核心库"
D[include/]
E[src/]
end
A --> D
B --> D
C --> D
D --> E
F[Npcap SDK] --> A
F --> B
F --> C
```

**图示来源**  
- [advanced_analyzer.cpp](file://examples/advanced_analyzer.cpp)
- [live_capture.cpp](file://examples/live_capture.cpp)
- [performance_benchmark.cpp](file://examples/performance_benchmark.cpp)
- [CMakeLists.txt](file://examples/CMakeLists.txt)

**本节来源**  
- [examples](file://examples)
- [include](file://include)
- [src](file://src)

## 核心组件
各示例程序共享以下核心功能模块：
- **协议检测引擎**：基于 `protocol_detection.hpp` 实现多层协议识别。
- **解析器基类**：`base_parser.hpp` 提供统一接口，支持扩展应用层、传输层、网络层和数据链路层解析器。
- **流量统计模块**：`traffic_statistics.hpp` 用于收集和汇总网络流量信息。
- **网络工具集**：`network_utils.hpp` 提供 IP 地址转换、端口识别等辅助功能。

这些组件共同构成协议解析库的核心能力，被各示例程序调用以实现具体功能。

**本节来源**  
- [protocol_detection.hpp](file://include/detection/protocol_detection.hpp)
- [base_parser.hpp](file://include/parsers/base_parser.hpp)
- [traffic_statistics.hpp](file://include/statistics/traffic_statistics.hpp)
- [network_utils.hpp](file://include/utils/network_utils.hpp)

## 架构概览
整个示例系统的架构分为三层：捕获层、解析层和输出层。捕获层使用 Npcap 进行数据包获取；解析层调用 `protocol_praser` 库进行逐层协议解析；输出层负责将分析结果以结构化形式打印或记录。

```mermaid
graph TD
A[数据源] --> B{捕获方式}
B --> |实时| C[live_capture]
B --> |文件| D[advanced_analyzer]
B --> |压力测试| E[performance_benchmark]
C --> F[协议解析引擎]
D --> F
E --> F
F --> G[统计模块]
F --> H[日志输出]
G --> I[性能报告]
H --> J[控制台/文件]
```

**图示来源**  
- [advanced_analyzer.cpp](file://examples/advanced_analyzer.cpp)
- [live_capture.cpp](file://examples/live_capture.cpp)
- [performance_benchmark.cpp](file://examples/performance_benchmark.cpp)

## 详细组件分析

### 高级流量分析器（advanced_analyzer.cpp）
该程序用于对离线 pcap 文件进行深度协议分析。支持多层协议识别，包括 HTTP、DNS、FTP、SMTP 等应用层协议，并能提取关键字段如 URL、域名、邮件地址等。

#### 主要流程
```mermaid
flowchart TD
Start([开始]) --> OpenFile["打开 pcap 文件"]
OpenFile --> ReadPacket["读取数据包"]
ReadPacket --> ParseEthernet["解析以太网帧"]
ParseEthernet --> ParseIP["解析 IP 包"]
ParseIP --> ParseTransport["解析 TCP/UDP"]
ParseTransport --> ParseApplication["解析应用层协议"]
ParseApplication --> ExtractInfo["提取关键信息"]
ExtractInfo --> LogResult["记录分析结果"]
LogResult --> NextPacket{"是否还有数据包?"}
NextPacket --> |是| ReadPacket
NextPacket --> |否| End([结束])
```

**图示来源**  
- [advanced_analyzer.cpp](file://examples/advanced_analyzer.cpp#L50-L200)

**本节来源**  
- [advanced_analyzer.cpp](file://examples/advanced_analyzer.cpp)

### 实时数据包捕获（live_capture.cpp）
该程序实现网络接口的实时监听，持续捕获并解析经过的数据包。适用于网络监控、入侵检测等场景。

#### 实时捕获流程
```mermaid
sequenceDiagram
participant User as 用户
participant LiveCapture as live_capture
participant Npcap as Npcap驱动
participant Parser as 协议解析器
User->>LiveCapture : 启动程序
LiveCapture->>Npcap : 打开网络接口
Npcap-->>LiveCapture : 返回捕获句柄
loop 持续捕获
Npcap->>LiveCapture : 推送数据包
LiveCapture->>Parser : 调用解析函数
Parser-->>LiveCapture : 返回解析结果
LiveCapture->>User : 输出协议类型与基本信息
end
```

**图示来源**  
- [live_capture.cpp](file://examples/live_capture.cpp#L30-L150)

**本节来源**  
- [live_capture.cpp](file://examples/live_capture.cpp)

### 性能基准测试（performance_benchmark.cpp）
该程序用于评估协议解析库的处理性能，测量单位时间内可解析的数据包数量，支持不同负载下的压力测试。

#### 性能测试逻辑
```mermaid
flowchart TD
Start([开始]) --> LoadPcap["加载测试 pcap 文件"]
LoadPcap --> ResetTimer["重置计时器"]
ResetTimer --> ProcessPacket["处理单个数据包"]
ProcessPacket --> UpdateStats["更新统计信息"]
UpdateStats --> Next{"是否完成?"}
Next --> |否| ProcessPacket
Next --> |是| Calculate["计算吞吐量"]
Calculate --> Output["输出性能报告"]
Output --> End([结束])
```

**图示来源**  
- [performance_benchmark.cpp](file://examples/performance_benchmark.cpp#L40-L180)

**本节来源**  
- [performance_benchmark.cpp](file://examples/performance_benchmark.cpp)

## 依赖分析
示例程序依赖以下外部和内部组件：
- **Npcap SDK**：提供底层数据包捕获能力。
- **protocol_praser 核心库**：实现协议解析逻辑。
- **C++ STL**：用于容器、字符串处理等。
- **系统 API**：Windows 平台相关调用。

```mermaid
graph LR
A[示例程序] --> B[Npcap SDK]
A --> C[protocol_praser 库]
C --> D[C++ STL]
A --> E[Windows API]
```

**图示来源**  
- [examples/CMakeLists.txt](file://examples/CMakeLists.txt)
- [include](file://include)
- [src](file://src)

**本节来源**  
- [CMakeLists.txt](file://examples/CMakeLists.txt)

## 性能考量
- `performance_benchmark.cpp` 提供量化指标，可用于优化解析器性能。
- 所有示例均采用零拷贝设计，通过 `buffer_view` 减少内存复制开销。
- 协议检测使用状态机模型，确保 O(n) 时间复杂度。

## 故障排除指南
常见问题包括：
- Npcap 未安装导致捕获失败。
- 权限不足无法访问网络接口。
- pcap 文件格式不兼容。
- 解析器未正确注册导致协议识别失败。

建议检查日志输出、确认环境配置，并使用 `iflist.c` 示例验证网络接口状态。

**本节来源**  
- [errors.cpp](file://src/utils/errors.cpp)
- [logging.hpp](file://include/utils/logging.hpp)

## 结论
`examples` 目录中的三个示例程序完整展示了 `protocol_praser` 库的集成方式与使用场景。开发者可基于这些模板快速构建自定义的网络分析工具，实现从数据捕获到深度解析的全流程控制。